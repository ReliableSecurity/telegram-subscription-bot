<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Личный кабинет - Subscription Bot</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .header h1 {
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .header .user-info {
            margin-top: 10px;
            color: #666;
        }

        .logout-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            float: right;
            margin-top: -10px;
        }

        .logout-btn:hover {
            background: #c82333;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .stat-card .icon {
            font-size: 2.5em;
            margin-bottom: 10px;
            color: #667eea;
        }

        .stat-card h3 {
            color: #333;
            margin-bottom: 10px;
        }

        .stat-card .value {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
        }

        .content-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .content-section h2 {
            color: #333;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .plan-status {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .plan-status.active {
            background: #d4edda;
            border: 1px solid #c3e6cb;
        }

        .plan-status.expired {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
        }

        .plan-badge {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .plan-badge.active {
            background: #28a745;
            color: white;
        }

        .plan-badge.expired {
            background: #dc3545;
            color: white;
        }

        .plan-badge.free {
            background: #6c757d;
            color: white;
        }

        .chart-container {
            height: 300px;
            margin-top: 20px;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
        }

        .success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5a6fd8;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .nav-menu {
            display: flex;
            gap: 15px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .nav-link {
            padding: 8px 16px;
            background: #667eea;
            color: white;
            text-decoration: none;
            border-radius: 5px;
            transition: background-color 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .nav-link:hover {
            background: #5a6fd8;
            color: white;
        }

        .nav-link.active {
            background: #28a745;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
        }

        .modal-content {
            background: white;
            margin: 15% auto;
            padding: 20px;
            border-radius: 10px;
            width: 80%;
            max-width: 600px;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: black;
        }

        .payment-methods {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .payment-method {
            border: 2px solid #ddd;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .payment-method:hover {
            border-color: #667eea;
            background: #f8f9fa;
        }

        .payment-method.selected {
            border-color: #667eea;
            background: #e6f3ff;
        }

        .payment-method .icon {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .crypto-icon {
            color: #f7931a;
        }

        .card-icon {
            color: #4285f4;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .ban-type {
            display: flex;
            gap: 10px;
            margin: 10px 0;
        }

        .ban-type label {
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>
                <i class="fas fa-user-circle"></i>
                Личный кабинет
            </h1>
            <div class="user-info">
                Добро пожаловать, <span id="user-name">Пользователь</span>
            </div>
            <div class="nav-menu">
                <a href="/user-dashboard" class="nav-link active">
                    <i class="fas fa-home"></i> Главная
                </a>
                <a href="/group-selector" class="nav-link">
                    <i class="fas fa-users"></i> Мои группы
                </a>
                <a href="/violations" class="nav-link">
                    <i class="fas fa-shield-alt"></i> Нарушения
                </a>
                <a href="#" class="nav-link" onclick="showPaymentModal()">
                    <i class="fas fa-credit-card"></i> Оплата
                </a>
            </div>
            <button class="logout-btn" onclick="logout()">
                <i class="fas fa-sign-out-alt"></i> Выход
            </button>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="icon"><i class="fas fa-calendar-alt"></i></div>
                <h3>Активная подписка</h3>
                <div class="value" id="active-plan">-</div>
            </div>
            <div class="stat-card">
                <div class="icon"><i class="fas fa-clock"></i></div>
                <h3>Осталось дней</h3>
                <div class="value" id="days-left">-</div>
            </div>
            <div class="stat-card">
                <div class="icon"><i class="fas fa-credit-card"></i></div>
                <h3>Всего потрачено</h3>
                <div class="value" id="total-spent">-</div>
            </div>
        </div>

        <div class="content-section">
            <h2>
                <i class="fas fa-crown"></i>
                Мой план
            </h2>
            <div id="plan-status" class="plan-status">
                <div>
                    <strong>Текущий план:</strong> <span id="current-plan">Загрузка...</span>
                    <span id="plan-badge" class="plan-badge">-</span>
                </div>
                <div>
                    <strong>Действует до:</strong> <span id="expires-at">-</span>
                </div>
            </div>
            <button class="btn btn-primary" onclick="showUpgradeModal()">
                <i class="fas fa-arrow-up"></i> Обновить план
            </button>
        </div>

        <div class="content-section">
            <h2>
                <i class="fas fa-history"></i>
                История платежей
            </h2>
            <div id="payment-history">
                <div class="loading">Загрузка истории платежей...</div>
            </div>
        </div>

        <div class="content-section">
            <h2>
                <i class="fas fa-cog"></i>
                Настройки
            </h2>
            <button class="btn btn-success" onclick="changePassword()">
                <i class="fas fa-key"></i> Изменить пароль
            </button>
        </div>
    </div>

    <!-- Модальное окно оплаты -->
    <div id="paymentModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('paymentModal')">&times;</span>
            <h2>Оплата подписки</h2>
            
            <div class="form-group">
                <label for="plan-select">Выберите план:</label>
                <select id="plan-select">
                    <option value="">Загрузка планов...</option>
                </select>
            </div>
            
            <div class="payment-methods">
                <div class="payment-method" onclick="selectPaymentMethod('card')">
                    <div class="icon card-icon">
                        <i class="fas fa-credit-card"></i>
                    </div>
                    <div>Банковская карта</div>
                    <div style="font-size: 0.9em; color: #666;">Visa, MasterCard</div>
                </div>
                
                <div class="payment-method" onclick="selectPaymentMethod('bitcoin')">
                    <div class="icon crypto-icon">
                        <i class="fab fa-bitcoin"></i>
                    </div>
                    <div>Bitcoin</div>
                    <div style="font-size: 0.9em; color: #666;">BTC</div>
                </div>
                
                <div class="payment-method" onclick="selectPaymentMethod('ethereum')">
                    <div class="icon crypto-icon">
                        <i class="fab fa-ethereum"></i>
                    </div>
                    <div>Ethereum</div>
                    <div style="font-size: 0.9em; color: #666;">ETH</div>
                </div>
                
                <div class="payment-method" onclick="selectPaymentMethod('usdt')">
                    <div class="icon crypto-icon">
                        <i class="fas fa-coins"></i>
                    </div>
                    <div>USDT</div>
                    <div style="font-size: 0.9em; color: #666;">TRC-20</div>
                </div>
            </div>
            
            <div id="payment-details" style="display: none;">
                <div class="form-group">
                    <label>Сумма к оплате:</label>
                    <div id="payment-amount" style="font-size: 1.2em; font-weight: bold; color: #667eea;">$0.00</div>
                </div>
                
                <button class="btn btn-primary" onclick="processPayment()">
                    <i class="fas fa-credit-card"></i> Оплатить
                </button>
            </div>
        </div>
    </div>

    <!-- Модальное окно модерации -->
    <div id="moderationModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('moderationModal')">&times;</span>
            <h2>Управление модерацией</h2>
            
            <div class="form-group">
                <label for="user-id">ID пользователя:</label>
                <input type="number" id="user-id" placeholder="Введите ID пользователя">
            </div>
            
            <div class="form-group">
                <label for="ban-reason">Причина блокировки:</label>
                <input type="text" id="ban-reason" placeholder="Нарушение правил">
            </div>
            
            <div class="form-group">
                <label>Тип блокировки:</label>
                <div class="ban-type">
                    <label>
                        <input type="radio" name="ban-type" value="temporary" checked>
                        Временная
                    </label>
                    <label>
                        <input type="radio" name="ban-type" value="permanent">
                        Постоянная
                    </label>
                </div>
            </div>
            
            <div class="form-group" id="ban-duration">
                <label for="ban-hours">Длительность (часы):</label>
                <input type="number" id="ban-hours" value="24" min="1">
            </div>
            
            <button class="btn btn-danger" onclick="banUser()">
                <i class="fas fa-ban"></i> Заблокировать
            </button>
            
            <hr style="margin: 20px 0;">
            
            <h3>Настройки автомодерации</h3>
            
            <div class="form-group">
                <label>
                    <input type="checkbox" id="auto-ban-enabled" checked>
                    Включить автоматическую блокировку
                </label>
            </div>
            
            <div class="form-group">
                <label for="violations-threshold">Количество нарушений для блокировки:</label>
                <input type="number" id="violations-threshold" value="3" min="1">
            </div>
            
            <div class="form-group">
                <label for="ban-duration-hours">Длительность блокировки (часы):</label>
                <input type="number" id="ban-duration-hours" value="24" min="1">
            </div>
            
            <button class="btn btn-success" onclick="saveModerationSettings()">
                <i class="fas fa-save"></i> Сохранить настройки
            </button>
        </div>
    </div>

    <script>
        let authToken = localStorage.getItem('authToken');
        let userStats = {};

        function checkAuth() {
            console.log('Checking auth token:', authToken);
            if (!authToken) {
                console.log('No auth token found, redirecting to login');
                window.location.href = '/';
                return false;
            }
            return true;
        }

        function logout() {
            localStorage.removeItem('authToken');
            window.location.href = '/';
        }

        // Модальные окна
        function showPaymentModal() {
            // Redirect to payment page with user token
            const token = localStorage.getItem('auth_token');
            if (token) {
                window.location.href = `/payment?token=${token}`;
            } else {
                alert('Ошибка аутентификации. Попробуйте войти заново.');
            }
        }

        function showModerationModal() {
            loadModerationSettings();
            document.getElementById('moderationModal').style.display = 'block';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // Загрузка планов
        async function loadPlans() {
            try {
                const response = await fetch('/api/plans', {
                    headers: {
                        'Authorization': authToken,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to load plans');
                }

                const plans = await response.json();
                const planSelect = document.getElementById('plan-select');
                planSelect.innerHTML = '<option value="">Выберите план</option>';
                
                plans.forEach(plan => {
                    const option = document.createElement('option');
                    option.value = plan.id;
                    option.textContent = `${plan.name} - $${plan.price}`;
                    option.dataset.price = plan.price;
                    planSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading plans:', error);
            }
        }

        // Загрузка методов оплаты
        async function loadPaymentMethods() {
            try {
                const response = await fetch('/api/payment/methods', {
                    headers: {
                        'Authorization': authToken,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to load payment methods');
                }

                const methods = await response.json();
                console.log('Payment methods loaded:', methods);
            } catch (error) {
                console.error('Error loading payment methods:', error);
            }
        }

        // Выбор метода оплаты
        let selectedPaymentMethod = null;
        function selectPaymentMethod(method) {
            // Убрать выделение со всех методов
            document.querySelectorAll('.payment-method').forEach(el => {
                el.classList.remove('selected');
            });
            
            // Выделить выбранный метод
            event.target.closest('.payment-method').classList.add('selected');
            selectedPaymentMethod = method;
            
            // Показать детали оплаты
            const planSelect = document.getElementById('plan-select');
            const selectedPlan = planSelect.options[planSelect.selectedIndex];
            
            if (selectedPlan && selectedPlan.dataset.price) {
                document.getElementById('payment-amount').textContent = `$${selectedPlan.dataset.price}`;
                document.getElementById('payment-details').style.display = 'block';
            }
        }

        // Обработка изменения плана
        document.getElementById('plan-select').addEventListener('change', function() {
            const selectedPlan = this.options[this.selectedIndex];
            if (selectedPlan && selectedPlan.dataset.price && selectedPaymentMethod) {
                document.getElementById('payment-amount').textContent = `$${selectedPlan.dataset.price}`;
                document.getElementById('payment-details').style.display = 'block';
            } else {
                document.getElementById('payment-details').style.display = 'none';
            }
        });

        // Обработка оплаты
        async function processPayment() {
            const planSelect = document.getElementById('plan-select');
            const selectedPlan = planSelect.options[planSelect.selectedIndex];
            
            if (!selectedPlan.value || !selectedPaymentMethod) {
                alert('Выберите план и метод оплаты');
                return;
            }

            try {
                const response = await fetch('/api/payment/create', {
                    method: 'POST',
                    headers: {
                        'Authorization': authToken,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        plan_id: parseInt(selectedPlan.value),
                        payment_method: selectedPaymentMethod,
                        amount: parseFloat(selectedPlan.dataset.price),
                        currency: 'USD'
                    })
                });

                if (!response.ok) {
                    throw new Error('Failed to create payment');
                }

                const result = await response.json();
                
                if (result.payment_url) {
                    window.open(result.payment_url, '_blank');
                }
                
                alert('Платеж создан! Перейдите по ссылке для завершения оплаты.');
                closeModal('paymentModal');
            } catch (error) {
                console.error('Error processing payment:', error);
                alert('Ошибка при обработке платежа');
            }
        }

        // Блокировка пользователя
        async function banUser() {
            const userId = document.getElementById('user-id').value;
            const reason = document.getElementById('ban-reason').value;
            const banType = document.querySelector('input[name="ban-type"]:checked').value;
            const hours = banType === 'temporary' ? parseInt(document.getElementById('ban-hours').value) : 0;

            if (!userId || !reason) {
                alert('Заполните все поля');
                return;
            }

            try {
                const response = await fetch('/api/moderation/ban', {
                    method: 'POST',
                    headers: {
                        'Authorization': authToken,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        user_id: parseInt(userId),
                        reason: reason,
                        ban_type: banType,
                        hours: hours
                    })
                });

                if (!response.ok) {
                    throw new Error('Failed to ban user');
                }

                alert('Пользователь заблокирован');
                closeModal('moderationModal');
            } catch (error) {
                console.error('Error banning user:', error);
                alert('Ошибка при блокировке пользователя');
            }
        }

        // Загрузка настроек модерации
        async function loadModerationSettings() {
            try {
                const response = await fetch('/api/moderation/settings', {
                    headers: {
                        'Authorization': authToken,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to load moderation settings');
                }

                const settings = await response.json();
                document.getElementById('auto-ban-enabled').checked = settings.auto_ban_enabled;
                document.getElementById('violations-threshold').value = settings.violations_threshold;
                document.getElementById('ban-duration-hours').value = settings.ban_duration_hours;
            } catch (error) {
                console.error('Error loading moderation settings:', error);
            }
        }

        // Сохранение настроек модерации
        async function saveModerationSettings() {
            const settings = {
                chat_id: 0,
                auto_ban_enabled: document.getElementById('auto-ban-enabled').checked,
                violations_threshold: parseInt(document.getElementById('violations-threshold').value),
                ban_duration_hours: parseInt(document.getElementById('ban-duration-hours').value),
                permanent_ban_threshold: 10
            };

            try {
                const response = await fetch('/api/moderation/settings', {
                    method: 'PUT',
                    headers: {
                        'Authorization': authToken,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(settings)
                });

                if (!response.ok) {
                    throw new Error('Failed to save moderation settings');
                }

                alert('Настройки модерации сохранены');
            } catch (error) {
                console.error('Error saving moderation settings:', error);
                alert('Ошибка при сохранении настроек');
            }
        }

        // Обработка изменения типа блокировки
        document.addEventListener('DOMContentLoaded', function() {
            const banTypeRadios = document.querySelectorAll('input[name="ban-type"]');
            const banDurationDiv = document.getElementById('ban-duration');
            
            banTypeRadios.forEach(radio => {
                radio.addEventListener('change', function() {
                    banDurationDiv.style.display = this.value === 'temporary' ? 'block' : 'none';
                });
            });
        });

        // Закрытие модальных окон при клике вне них
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        }

        function setAuthHeaders() {
            return {
                'Authorization': authToken,
                'Content-Type': 'application/json'
            };
        }

        async function loadUserData() {
            try {
                console.log('Loading user data with token:', authToken);
                const response = await fetch('/api/user/profile', {
                    headers: {
                        'Authorization': authToken,
                        'Content-Type': 'application/json'
                    }
                });

                console.log('Response status:', response.status);
                console.log('Response ok:', response.ok);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Error response:', errorText);
                    
                    if (response.status === 401) {
                        showError('Ошибка авторизации. Перенаправление на страницу входа...');
                        setTimeout(() => logout(), 2000);
                        return;
                    }
                    throw new Error('Failed to load user data: ' + errorText);
                }

                const userData = await response.json();
                console.log('User data loaded:', userData);
                updateUserInterface(userData);
            } catch (error) {
                console.error('Error loading user data:', error);
                showError('Ошибка загрузки данных пользователя: ' + error.message);
            }
        }

        function updateUserInterface(userData) {
            // Update user info
            document.getElementById('user-name').textContent = userData.first_name || 'Пользователь';
            
            // Update stats
            document.getElementById('active-plan').textContent = userData.plan_name || 'Бесплатный';
            
            if (userData.plan_expires_at) {
                const expiryDate = new Date(userData.plan_expires_at);
                const now = new Date();
                const daysLeft = Math.ceil((expiryDate - now) / (1000 * 60 * 60 * 24));
                document.getElementById('days-left').textContent = daysLeft > 0 ? daysLeft : 0;
                document.getElementById('expires-at').textContent = expiryDate.toLocaleDateString();
            } else {
                document.getElementById('days-left').textContent = '∞';
                document.getElementById('expires-at').textContent = 'Бессрочно';
            }

            document.getElementById('total-spent').textContent = `$${userData.total_spent || '0.00'}`;

            // Update plan status
            const planStatus = document.getElementById('plan-status');
            const planBadge = document.getElementById('plan-badge');
            const currentPlan = document.getElementById('current-plan');
            
            currentPlan.textContent = userData.plan_name || 'Бесплатный';
            
            if (userData.plan_expires_at) {
                const expiryDate = new Date(userData.plan_expires_at);
                const now = new Date();
                
                if (expiryDate > now) {
                    planStatus.className = 'plan-status active';
                    planBadge.className = 'plan-badge active';
                    planBadge.textContent = 'Активен';
                } else {
                    planStatus.className = 'plan-status expired';
                    planBadge.className = 'plan-badge expired';
                    planBadge.textContent = 'Истёк';
                }
            } else {
                planStatus.className = 'plan-status';
                planBadge.className = 'plan-badge free';
                planBadge.textContent = 'Бесплатный';
            }
        }

        async function loadPaymentHistory() {
            try {
                const response = await fetch('/api/user/payments', {
                    headers: {
                        'Authorization': authToken,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to load payment history');
                }

                const payments = await response.json();
                displayPaymentHistory(payments);
            } catch (error) {
                console.error('Error loading payment history:', error);
                document.getElementById('payment-history').innerHTML = 
                    '<div class="error">Ошибка загрузки истории платежей</div>';
            }
        }

        function displayPaymentHistory(payments) {
            const container = document.getElementById('payment-history');
            
            if (payments.length === 0) {
                container.innerHTML = '<div class="loading">Платежи не найдены</div>';
                return;
            }

            let html = '<div style="overflow-x: auto;"><table style="width: 100%; border-collapse: collapse;">';
            html += '<thead><tr style="background: #f8f9fa;">';
            html += '<th style="padding: 10px; border: 1px solid #ddd;">Дата</th>';
            html += '<th style="padding: 10px; border: 1px solid #ddd;">Сумма</th>';
            html += '<th style="padding: 10px; border: 1px solid #ddd;">Статус</th>';
            html += '<th style="padding: 10px; border: 1px solid #ddd;">Метод</th>';
            html += '</tr></thead><tbody>';

            payments.forEach(payment => {
                html += '<tr>';
                html += `<td style="padding: 10px; border: 1px solid #ddd;">${new Date(payment.created_at).toLocaleDateString()}</td>`;
                html += `<td style="padding: 10px; border: 1px solid #ddd;">$${payment.amount.toFixed(2)}</td>`;
                html += `<td style="padding: 10px; border: 1px solid #ddd;">
                    <span class="plan-badge ${payment.status === 'completed' ? 'active' : 'expired'}">
                        ${payment.status}
                    </span>
                </td>`;
                html += `<td style="padding: 10px; border: 1px solid #ddd;">${payment.payment_method}</td>`;
                html += '</tr>';
            });

            html += '</tbody></table></div>';
            container.innerHTML = html;
        }

        function showUpgradeModal() {
            // Redirect to payment page with user token
            const token = localStorage.getItem('auth_token');
            if (token) {
                window.location.href = `/payment?token=${token}`;
            } else {
                alert('Ошибка аутентификации. Попробуйте войти заново.');
            }
        }

        function changePassword() {
            const newPassword = prompt('Введите новый пароль:');
            if (newPassword && newPassword.length >= 6) {
                // Implement password change
                alert('Функция смены пароля будет доступна в ближайшее время!');
            } else if (newPassword) {
                alert('Пароль должен содержать не менее 6 символов');
            }
        }

        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.textContent = message;
            document.body.insertBefore(errorDiv, document.body.firstChild);
            
            setTimeout(() => {
                errorDiv.remove();
            }, 5000);
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, initializing...');
            
            // Check if token is in URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            const urlToken = urlParams.get('token');
            if (urlToken) {
                console.log('Token found in URL, saving to localStorage');
                localStorage.setItem('authToken', urlToken);
                authToken = urlToken;
                // Remove token from URL for security
                window.history.replaceState({}, document.title, window.location.pathname);
            }
            
            if (checkAuth()) {
                console.log('Auth check passed, loading data...');
                loadUserData();
                loadPaymentHistory();
            }
        });
    </script>
</body>
</html>